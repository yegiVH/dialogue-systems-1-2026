{"version":3,"sources":["src/common.speech/AvatarSynthesisAdapter.ts"],"names":[],"mappings":"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","file":"AvatarSynthesisAdapter.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT license.\r\n\r\nimport {\r\n    AvatarConfig,\r\n    AvatarEventArgs,\r\n    AvatarSynthesizer,\r\n    PropertyId,\r\n    Synthesizer,\r\n} from \"../sdk/Exports.js\";\r\nimport {\r\n    ISynthesisConnectionFactory,\r\n    ISynthesisMetadata,\r\n    ISynthesisSectionVideo,\r\n    SynthesisAdapterBase,\r\n    SynthesizerConfig\r\n} from \"./Exports.js\";\r\nimport { IAuthentication } from \"./IAuthentication.js\";\r\n\r\nexport class AvatarSynthesisAdapter extends SynthesisAdapterBase {\r\n    private readonly privAvatarSynthesizer: AvatarSynthesizer;\r\n    private readonly privAvatarConfig: AvatarConfig;\r\n\r\n    public constructor(\r\n        authentication: IAuthentication,\r\n        connectionFactory: ISynthesisConnectionFactory,\r\n        synthesizerConfig: SynthesizerConfig,\r\n        avatarSynthesizer: AvatarSynthesizer,\r\n        avatarConfig: AvatarConfig,\r\n        ) {\r\n\r\n        super(authentication, connectionFactory,\r\n            synthesizerConfig, undefined);\r\n        this.privAvatarSynthesizer = avatarSynthesizer;\r\n        this.privSynthesizer = avatarSynthesizer as Synthesizer;\r\n        this.privAvatarConfig = avatarConfig;\r\n    }\r\n\r\n    protected setSynthesisContextSynthesisSection(): void {\r\n        this.privSynthesisContext.setSynthesisSection(undefined);\r\n    }\r\n\r\n    protected setSpeechConfigSynthesisSection(): void {\r\n        const talkingAvatarConfig: ISynthesisSectionVideo[\"talkingAvatar\"] = {\r\n            background: {\r\n                color: this.privAvatarConfig.backgroundColor,\r\n                image: {\r\n                    url: this.privAvatarConfig.backgroundImage?.toString(),\r\n                }\r\n            },\r\n            character: this.privAvatarConfig.character,\r\n            customized: this.privAvatarConfig.customized,\r\n            photoAvatarBaseModel: this.privAvatarConfig.photoAvatarBaseModel,\r\n            style: this.privAvatarConfig.style,\r\n            useBuiltInVoice: this.privAvatarConfig.useBuiltInVoice,\r\n        };\r\n\r\n        // Add scene configuration if provided\r\n        if (this.privAvatarConfig.scene) {\r\n            talkingAvatarConfig.scene = {\r\n                amplitude: this.privAvatarConfig.scene.amplitude,\r\n                positionX: this.privAvatarConfig.scene.positionX,\r\n                positionY: this.privAvatarConfig.scene.positionY,\r\n                rotationX: this.privAvatarConfig.scene.rotationX,\r\n                rotationY: this.privAvatarConfig.scene.rotationY,\r\n                rotationZ: this.privAvatarConfig.scene.rotationZ,\r\n                zoom: this.privAvatarConfig.scene.zoom,\r\n            };\r\n        }\r\n\r\n        this.privSynthesizerConfig.synthesisVideoSection = {\r\n            format: {\r\n                bitrate: this.privAvatarConfig.videoFormat?.bitrate,\r\n                codec: this.privAvatarConfig.videoFormat?.codec,\r\n                crop: {\r\n                    bottomRight: {\r\n                        x: this.privAvatarConfig.videoFormat?.cropRange?.bottomRight?.x,\r\n                        y: this.privAvatarConfig.videoFormat?.cropRange?.bottomRight?.y,\r\n                    },\r\n                    topLeft: {\r\n                        x: this.privAvatarConfig.videoFormat?.cropRange?.topLeft?.x,\r\n                        y: this.privAvatarConfig.videoFormat?.cropRange?.topLeft?.y,\r\n                    },\r\n                },\r\n                resolution: {\r\n                    height: this.privAvatarConfig.videoFormat?.height,\r\n                    width: this.privAvatarConfig.videoFormat?.width,\r\n                },\r\n            },\r\n            protocol: {\r\n                name: \"WebRTC\",\r\n                webrtcConfig: {\r\n                    clientDescription: btoa(this.privSynthesizerConfig.parameters.getProperty(PropertyId.TalkingAvatarService_WebRTC_SDP)),\r\n                    iceServers: this.privAvatarConfig.remoteIceServers ?? this.privAvatarSynthesizer.iceServers,\r\n                },\r\n            },\r\n            talkingAvatar: talkingAvatarConfig,\r\n        } as ISynthesisSectionVideo;\r\n    }\r\n\r\n\r\n    protected onAvatarEvent(metadata: ISynthesisMetadata): void {\r\n        if (!!this.privAvatarSynthesizer.avatarEventReceived) {\r\n            const avatarEventArgs: AvatarEventArgs = new AvatarEventArgs(\r\n                metadata.Data.Offset,\r\n                metadata.Data.Name);\r\n            try {\r\n                this.privAvatarSynthesizer.avatarEventReceived(this.privAvatarSynthesizer, avatarEventArgs);\r\n            } catch (error) {\r\n                // Not going to let errors in the event handler\r\n                // trip things up.\r\n            }\r\n        }\r\n    }\r\n}\r\n"]}